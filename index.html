<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 å°å¤§ç”Ÿå·¥ç‡Ÿ</title>
    
    <!-- å¼•å…¥ FontAwesome åœ–ç¤º -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- 1. è¨­è¨ˆç³»çµ± (Design System) --- */
        :root {
            --primary: #2AB7CA; /* æµ·å ±äº®é’è‰² */
            --primary-dark: #239cb0;
            --secondary: #76C95A; /* æµ·å ±è‰åœ°ç¶  */
            --accent: #FF9F1C; /* æ©˜è‰²é»ç¶´ */
            --bg: #F0F9FF;
            --text: #333333;
            --card-bg: #FFFFFF;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 0;
            overflow-x: hidden;
            padding-bottom: 90px; /* ç•™çµ¦åº•éƒ¨å°èˆª */
        }

        /* --- 2. ç™»å…¥é®ç½©å±¤ --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 20px;
        }
        .login-card {
            background: white; width: 100%; max-width: 350px;
            padding: 30px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }
        .login-logo {
            width: 80px; height: 80px; background: var(--bg);
            border-radius: 50%; margin: 0 auto 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; color: var(--primary);
        }

        /* --- 3. é€šç”¨å…ƒä»¶ --- */
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        h1, h2, h3 { color: var(--primary-dark); margin-top: 0; }
        
        .card {
            background: var(--card-bg); border-radius: 16px; padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(42, 183, 202, 0.1);
            border: 1px solid rgba(255,255,255,0.8);
        }

        .btn {
            background: var(--primary); color: white; border: none;
            padding: 14px; border-radius: 50px; font-size: 16px; font-weight: bold;
            width: 100%; cursor: pointer; transition: 0.2s; margin-top: 10px;
        }
        .btn:active { transform: scale(0.98); background: var(--primary-dark); }
        .btn-secondary { background: var(--secondary); }

        input, textarea {
            width: 100%; padding: 12px; margin-bottom: 12px;
            border: 2px solid #E0E0E0; border-radius: 10px;
            font-size: 16px; outline: none; transition: 0.3s;
        }
        input:focus, textarea:focus { border-color: var(--primary); }

        /* --- 4. å¯¦é©—å³æ™‚åŒæ­¥å€å¡Š --- */
        .lab-input-group {
            margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #eee;
        }
        .lab-input-group label {
            display: block; font-weight: bold; margin-bottom: 5px; color: #555;
        }
        .sync-status {
            font-size: 12px; color: var(--secondary); text-align: right;
            display: flex; align-items: center; justify-content: flex-end; gap: 5px;
        }
        .sync-dot {
            width: 8px; height: 8px; background-color: #ccc; border-radius: 50%;
        }
        .sync-dot.active { background-color: var(--secondary); box-shadow: 0 0 5px var(--secondary); }

        /* --- 5. åº•éƒ¨å°èˆª --- */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; display: flex; justify-content: space-around;
            padding: 12px 0; box-shadow: 0 -2px 15px rgba(0,0,0,0.05);
            z-index: 1000; padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item {
            text-align: center; font-size: 11px; color: #aaa;
            cursor: pointer; width: 20%; transition: 0.3s;
        }
        .nav-item.active { color: var(--primary); transform: translateY(-2px); }
        .nav-icon { font-size: 22px; display: block; margin-bottom: 4px; }

        /* --- é é¢åˆ‡æ› --- */
        .page { display: none; padding-top: 20px; }
        .page.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Loading */
        .loading { color: #ccc; font-style: italic; }
    </style>
</head>
<body>

    <!-- 1. ç™»å…¥ç•«é¢ (é è¨­é¡¯ç¤º) -->
    <div id="login-overlay">
        <div class="login-card">
            <div class="login-logo"><i class="fas fa-water"></i></div>
            <h2 style="color: var(--primary);">å­¸å“¡ç™»å…¥</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 20px;">è«‹è¼¸å…¥å ±åæ™‚çš„å§“åèˆ‡èº«åˆ†è­‰å­—è™Ÿ</p>
            
            <input type="text" id="loginName" placeholder="å§“å (ä¾‹ï¼šç‹å°æ˜)">
            <input type="password" id="loginID" placeholder="èº«åˆ†è­‰å­—è™Ÿ (ä¾‹ï¼šA123456789)">
            
            <button class="btn" id="btnLogin" onclick="handleLogin()">ç™»å…¥ç³»çµ±</button>
            <p id="loginMsg" style="color: red; font-size: 13px; margin-top: 10px;"></p>
        </div>
    </div>

    <!-- 2. App ä¸»ç•«é¢ (ç™»å…¥å¾Œé¡¯ç¤º) -->
    <div id="app-container" style="display: none;">
        
        <!-- é¦–é  -->
        <div id="home" class="page active container">
            <div style="text-align: center; margin-bottom: 20px;">
                <h1 style="margin-bottom: 5px;">2026 å°å¤§ç”Ÿå·¥ç‡Ÿ</h1>
                <p style="color: #666; font-size: 14px;">Hi, <span id="user-name-display" style="font-weight: bold; color: var(--primary);">å­¸å“¡</span></p>
            </div>

            <div class="card" style="background: linear-gradient(135deg, var(--primary), #4DD0E1); color: white; border:none;">
                <h3><i class="fas fa-bullhorn"></i> æœ€æ–°å…¬å‘Š</h3>
                <p>æ­¡è¿å¤§å®¶ï¼ç¾åœ¨è«‹å‰å¾€ã€Œå¤§ç¦®å ‚ã€é›†åˆåƒåŠ é–‹å¹•å¼ã€‚</p>
                <div style="text-align: right; font-size: 12px; opacity: 0.8;">å‰›å‰›æ›´æ–°</div>
            </div>

            <div class="card">
                <h3><i class="fas fa-id-card"></i> æˆ‘çš„è³‡è¨Š</h3>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>å°éšŠ</span>
                    <strong style="color: var(--primary); font-size: 18px;">ç¬¬ <span id="info-group">--</span> å°éšŠ</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span>æˆ¿é–“</span>
                    <strong style="color: var(--accent); font-size: 18px;"><span id="info-room">--</span> æˆ¿</strong>
                </div>
            </div>
        </div>

        <!-- æµç¨‹ -->
        <div id="schedule" class="page container">
            <h2>ğŸ“… æ´»å‹•æµç¨‹</h2>
            <div class="card">
                <h3 style="color: var(--secondary);">Day 1 (ä»Šæ—¥)</h3>
                <div style="border-left: 3px solid #eee; padding-left: 15px; margin-left: 5px;">
                    <p><strong>09:00</strong> å§‹æ¥­å¼ <span style="font-size:12px; color:#888;">@åšé›…101</span></p>
                    <p><strong>10:30</strong> ç ´å†°éŠæˆ² <span style="font-size:12px; color:#888;">@èˆŠé«”è‚²é¤¨</span></p>
                    <p style="color: var(--primary);"><strong>14:00</strong> å¯¦é©— Iï¼šæ°´è³ªæª¢æ¸¬ <span style="font-size:12px; color:var(--primary);">@ç”Ÿå·¥ç³»é¤¨</span></p>
                </div>
            </div>
        </div>

        <!-- å¯¦é©— (é‡é»åŠŸèƒ½) -->
        <div id="lab" class="page container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>âš—ï¸ å¯¦é©—ç´€éŒ„</h2>
                <div class="sync-status">
                    <div class="sync-dot active"></div> <span id="sync-text">é›²ç«¯é€£ç·šä¸­</span>
                </div>
            </div>
            
            <div class="card" style="border-top: 4px solid var(--accent);">
                <p style="margin-bottom: 20px; font-size: 14px; color: #666;">
                    <i class="fas fa-users"></i> é€™æ˜¯ç¬¬ <b id="lab-group-display">--</b> å°éšŠçš„å…±ç”¨ç´€éŒ„è¡¨ã€‚<br>
                    ä»»ä½•äººè¼¸å…¥ï¼Œçµ„å“¡æ‰‹æ©Ÿéƒ½æœƒåŒæ­¥ï¼
                </p>

                <div class="lab-input-group">
                    <label>1. æ¡æ¨£æ°´æºåœ°é»</label>
                    <input type="text" id="lab-q1" placeholder="ä¾‹å¦‚ï¼šé†‰æœˆæ¹–ç•”" oninput="updateLabData('q1', this.value)">
                </div>

                <div class="lab-input-group">
                    <label>2. æ¸¬é‡ pH å€¼</label>
                    <input type="number" id="lab-q2" placeholder="ä¾‹å¦‚ï¼š7.0" oninput="updateLabData('q2', this.value)">
                </div>

                <div class="lab-input-group">
                    <label>3. è§€å¯Ÿç¾è±¡æè¿°</label>
                    <textarea id="lab-q3" rows="3" placeholder="æ°´é«”é¡è‰²ã€æ°£å‘³..." oninput="updateLabData('q3', this.value)"></textarea>
                </div>
                
                <p style="font-size: 12px; color: #aaa; text-align: center;">è³‡æ–™è‡ªå‹•å„²å­˜æ–¼ Firebase</p>
            </div>
        </div>

        <!-- åˆ†æˆ¿èˆ‡å®¤å‹ -->
        <div id="room" class="page container">
            <h2>ğŸ›Œ ä½å®¿è³‡è¨Š</h2>
            <div class="card">
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 14px; color: #888;">ä½ çš„æˆ¿é–“</div>
                    <div style="font-size: 60px; font-weight: 800; color: var(--accent); line-height: 1;">
                        <span id="room-number-big">--</span>
                    </div>
                </div>
                <hr style="border: 0; border-top: 1px solid #eee;">
                <h3><i class="fas fa-user-friends"></i> ä½ çš„å®¤å‹</h3>
                <ul id="roommate-list" style="padding-left: 20px; line-height: 1.8;">
                    <li class="loading">è®€å–ä¸­...</li>
                </ul>
            </div>
        </div>

        <!-- åº•éƒ¨å°èˆª -->
        <div class="nav-bar">
            <div class="nav-item active" onclick="switchPage('home', this)">
                <i class="fas fa-home nav-icon"></i>é¦–é 
            </div>
            <div class="nav-item" onclick="switchPage('schedule', this)">
                <i class="fas fa-calendar-alt nav-icon"></i>æµç¨‹
            </div>
            <div class="nav-item" onclick="switchPage('lab', this)">
                <i class="fas fa-flask nav-icon"></i>å¯¦é©—
            </div>
            <div class="nav-item" onclick="switchPage('room', this)">
                <i class="fas fa-bed nav-icon"></i>åˆ†æˆ¿
            </div>
        </div>
    </div>

    <!-- Firebase SDK (ä½¿ç”¨æ¨¡çµ„åŒ–ç‰ˆæœ¬) -->
    <script type="module">
        // --- 1. å¼•å…¥ Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 2. è²¼ä¸Šä½ çš„è¨­å®š (å·²è‡ªå‹•å¡«å…¥) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCIrDF_HbcjgvafKfGRjF7VhB0pLpJO6W8",
            authDomain: "bse-camp.firebaseapp.com",
            projectId: "bse-camp",
            storageBucket: "bse-camp.firebasestorage.app",
            messagingSenderId: "287416151522",
            appId: "1:287416151522:web:435f09982f54943ba75dbb",
            measurementId: "G-2JWGRWT0EX"
        };

        // åˆå§‹åŒ–
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 3. ç‡ŸéšŠå­¸å“¡è³‡æ–™åº« (ä½ å¯ä»¥æ‰‹å‹•åœ¨é€™è£¡ç·¨è¼¯) ---
        // æ³¨æ„ï¼šé€™åªæ˜¯ç‚ºäº†ç™»å…¥é©—è­‰ç”¨çš„æœ¬åœ°åå–®ï¼ŒçœŸå¯¦çš„å¯¦é©—æ•¸æ“šæœƒå­˜åœ¨é›²ç«¯
        // ID æ¬„ä½è«‹ç”¨å¤§å¯«
        const campersDB = [
            { name: "ç‹å°æ˜", id: "A123456789", group: "1", room: "501", roommates: ["å¼µä¸‰", "æå››"] },
            { name: "é™³å°ç¾", id: "B223456789", group: "2", room: "502", roommates: ["æ—æ—", "å°èŠ±"] },
            { name: "æ¸¬è©¦å“¡", id: "123", group: "1", room: "VIP", roommates: ["æ²’æœ‰äºº"] },
            { name: "çµ„å“¡B", id: "456", group: "1", room: "503", roommates: ["ç‹å°æ˜"] } 
        ];

        let currentUser = null; // ç™»å…¥å¾Œçš„ä½¿ç”¨è€…è³‡æ–™

        // --- 4. ç™»å…¥é‚è¼¯ ---
        window.handleLogin = async function() {
            const btn = document.getElementById('btnLogin');
            const msg = document.getElementById('loginMsg');
            const name = document.getElementById('loginName').value.trim();
            const id = document.getElementById('loginID').value.trim().toUpperCase();

            btn.innerText = "é©—è­‰ä¸­...";
            btn.disabled = true;

            // Step A: æœ¬åœ°é©—è­‰ (é˜²å›å­)
            const user = campersDB.find(c => c.name === name && c.id === id);
            
            if (!user) {
                msg.innerText = "æ‰¾ä¸åˆ°æ­¤è³‡æ–™ï¼Œè«‹æª¢æŸ¥å§“åæˆ–èº«åˆ†è­‰å­—è™Ÿã€‚";
                btn.innerText = "ç™»å…¥ç³»çµ±";
                btn.disabled = false;
                return;
            }

            // Step B: Firebase åŒ¿åç™»å…¥ (å–å¾—è³‡æ–™åº«è®€å¯«æ¬Šé™)
            try {
                await signInAnonymously(auth);
                console.log("Firebase ç™»å…¥æˆåŠŸ");
                
                currentUser = user;
                loginSuccess(user);

            } catch (error) {
                console.error(error);
                msg.innerText = "é€£ç·šå¤±æ•—ï¼š" + error.message;
                btn.innerText = "ç™»å…¥ç³»çµ±";
                btn.disabled = false;
            }
        };

        function loginSuccess(user) {
            // éš±è—ç™»å…¥é ï¼Œé¡¯ç¤ºä¸»é 
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';

            // å¡«å…¥å€‹äººè³‡è¨Š
            document.getElementById('user-name-display').innerText = user.name;
            document.getElementById('info-group').innerText = user.group;
            document.getElementById('info-room').innerText = user.room;
            
            // å¡«å…¥åˆ†æˆ¿é é¢è³‡è¨Š
            document.getElementById('room-number-big').innerText = user.room;
            const matesHtml = user.roommates.map(m => `<li>${m}</li>`).join('');
            document.getElementById('roommate-list').innerHTML = matesHtml || "<li>è‡ªå·±ä½çœŸçˆ½</li>";

            // å¡«å…¥å¯¦é©—é é¢è³‡è¨Š
            document.getElementById('lab-group-display').innerText = user.group;

            // *** å•Ÿå‹•å³æ™‚ç›£è½ (Real-time Listener) ***
            initLabSync(user.group);
        }

        // --- 5. å¯¦é©—æ•¸æ“šåŒæ­¥é‚è¼¯ (æœ€æ ¸å¿ƒåŠŸèƒ½) ---
        let unsubscribeLab = null;

        function initLabSync(groupId) {
            const docRef = doc(db, "lab_results", `group_${groupId}`);

            // ç›£è½é›²ç«¯è³‡æ–™è®ŠåŒ–
            unsubscribeLab = onSnapshot(docRef, (docSnap) => {
                const syncText = document.getElementById('sync-text');
                const dot = document.querySelector('.sync-dot');

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log("æ”¶åˆ°é›²ç«¯æ›´æ–°:", data);
                    
                    // æ›´æ–°è¼¸å…¥æ¡† (å¦‚æœä½¿ç”¨è€…æ­£åœ¨æ‰“å­—ï¼Œè¦å°å¿ƒä¸è¦è¦†è“‹ï¼Œé€™è£¡åšç°¡å–®è™•ç†)
                    if (document.activeElement.id !== 'lab-q1') document.getElementById('lab-q1').value = data.q1 || "";
                    if (document.activeElement.id !== 'lab-q2') document.getElementById('lab-q2').value = data.q2 || "";
                    if (document.activeElement.id !== 'lab-q3') document.getElementById('lab-q3').value = data.q3 || "";
                    
                    syncText.innerText = "å·²åŒæ­¥æœ€æ–°è³‡æ–™";
                    dot.classList.add('active');
                } else {
                    console.log("å°šç„¡è³‡æ–™ï¼Œå»ºç«‹æ–°æ–‡ä»¶ä¸­...");
                }
            }, (error) => {
                console.error("åŒæ­¥å¤±æ•—:", error);
                document.getElementById('sync-text').innerText = "é€£ç·šä¸­æ–·";
                document.querySelector('.sync-dot').classList.remove('active');
            });
        }

        // ç•¶ä½¿ç”¨è€…è¼¸å…¥æ™‚ï¼Œå¯«å…¥é›²ç«¯
        window.updateLabData = async function(field, value) {
            if (!currentUser) return;
            
            const groupId = currentUser.group;
            const docRef = doc(db, "lab_results", `group_${groupId}`);

            // é¡¯ç¤ºåŒæ­¥ä¸­ç‹€æ…‹
            document.getElementById('sync-text').innerText = "å„²å­˜ä¸­...";
            document.querySelector('.sync-dot').classList.remove('active');

            try {
                // merge: true ä»£è¡¨åªæ›´æ–°ä¿®æ”¹çš„æ¬„ä½ï¼Œä¸åˆªé™¤å…¶ä»–æ¬„ä½
                await setDoc(docRef, { [field]: value }, { merge: true });
                // æˆåŠŸå¾Œï¼Œä¸Šé¢çš„ onSnapshot æœƒå†æ”¶åˆ°ä¸€æ¬¡ç¢ºèªï¼Œç‹€æ…‹æœƒè®Šå›ã€Œå·²åŒæ­¥ã€
            } catch (e) {
                console.error("å¯«å…¥å¤±æ•—", e);
                alert("å¯«å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
            }
        };

        // --- 6. é é¢åˆ‡æ› ---
        window.switchPage = function(pageId, navElement) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            navElement.classList.add('active');
        };

    </script>
</body>
</html>