<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 å°å¤§ç”Ÿå·¥ç‡Ÿ</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- ğŸ¨ è¨­è¨ˆç³»çµ± --- */
        :root {
            --primary: #2AB7CA; 
            --primary-dark: #239cb0;
            --secondary: #76C95A; 
            --accent: #FF9F1C; 
            --urgent: #e63946;
            --bg: #F4F7F6;
            --text: #333;
            --card-bg: #FFFFFF;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: 0; padding-bottom: 90px; overflow-x: hidden;
        }

        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .card {
            background: var(--card-bg); border-radius: 16px; padding: 20px;
            margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.02); position: relative;
        }

        /* é¦–é ç‹€æ…‹å¡ç‰‡ */
        .home-status-card { cursor: pointer; transition: transform 0.2s; }
        .home-status-card:active { transform: scale(0.98); }

        /* ğŸš¨ å…¬å‘Šç‰¹æ•ˆ */
        .card.urgent { border: 2px solid var(--urgent); animation: border-pulse 2s infinite; }
        @keyframes border-pulse { 0% { border-color: var(--urgent); box-shadow: 0 0 5px rgba(230,57,70,0.2); } 50% { border-color: #ffb3b8; box-shadow: 0 0 15px rgba(230,57,70,0.4); } 100% { border-color: var(--urgent); box-shadow: 0 0 5px rgba(230,57,70,0.2); } }

        /* æŒ‰éˆ•èˆ‡è¡¨å–® */
        .btn { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 12px; font-size: 16px; font-weight: bold; width: 100%; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn:active { transform: scale(0.98); }
        .btn-secondary { background: var(--secondary); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-outline.active { background: var(--primary); color: white; }
        
        .back-btn { background: none; border: none; font-size: 16px; color: #666; cursor: pointer; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }

        /* ç™»å…¥èˆ‡ Loading */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary), var(--secondary)); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .login-box { background: white; width: 100%; max-width: 320px; padding: 30px; border-radius: 24px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .login-input { width: 100%; padding: 12px; margin-bottom: 12px; border: 2px solid #eee; border-radius: 10px; font-size: 16px; outline: none; }
        #loading-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 8000; display: none; justify-content: center; align-items: center; flex-direction: column; }

        /* ğŸ“… è¡Œç¨‹è¡¨ & å¯¦é©—åˆ‡æ› Tab */
        .day-tabs { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; scrollbar-width: none; }
        .day-tab { background: white; color: #888; padding: 8px 16px; border-radius: 20px; font-size: 14px; white-space: nowrap; border: 1px solid #eee; cursor: pointer; transition: 0.2s; }
        .day-tab.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(42, 183, 202, 0.3); transform: translateY(-2px); }
        
        .schedule-item { display: flex; align-items: flex-start; gap: 15px; padding: 15px; border-radius: 12px; background: white; margin-bottom: 12px; transition: 0.3s; }
        .schedule-item.active-now { border: 2px solid var(--primary); background: #e0f7fa; transform: scale(1.02); box-shadow: 0 4px 10px rgba(42, 183, 202, 0.2); z-index: 2; }
        .schedule-item.past { background: #f4f4f4; opacity: 0.6; border: 1px solid #eee; filter: grayscale(100%); }
        .schedule-item.past .time-badge { background: #e0e0e0; color: #888; }
        .time-badge { background: rgba(42, 183, 202, 0.1); color: var(--primary); padding: 5px 8px; border-radius: 6px; font-weight: bold; font-size: 14px; min-width: 65px; text-align: center; }

        /* ğŸ† æ’è¡Œæ¦œ */
        .score-row { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .score-row:last-child { border-bottom: none; }
        .rank-badge { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 12px; font-size: 14px; background: #eee; color: #666; flex-shrink: 0; }
        .rank-1 .rank-badge { background: #FFD700; color: #fff; box-shadow: 0 2px 5px rgba(255, 215, 0, 0.4); }
        .rank-2 .rank-badge { background: #C0C0C0; color: #fff; }
        .rank-3 .rank-badge { background: #CD7F32; color: #fff; }
        .group-info { flex: 0 0 100px; }
        .group-name { font-weight: bold; font-size: 15px; color: #333; }
        .score-bar-bg { flex: 1; height: 8px; background: #f0f0f0; border-radius: 4px; overflow: hidden; margin: 0 10px; }
        .score-bar-fill { height: 100%; background: var(--secondary); border-radius: 4px; }
        .score-num { font-weight: bold; font-size: 16px; min-width: 40px; text-align: right; color: var(--primary); }

        /* âš—ï¸ å¯¦é©—è¡¨å–®èˆ‡æ­·å²ç´€éŒ„ */
        .lab-form { display: flex; flex-direction: column; gap: 15px; }
        .lab-field { display: flex; flex-direction: column; }
        .lab-field label { font-size: 12px; color: #666; margin-bottom: 5px; font-weight: bold; }
        .lab-field input, .lab-field textarea { 
            padding: 10px; border: 2px solid #eee; border-radius: 8px; font-size: 16px; 
            background: #FAFAFA; width: 100%; transition: 0.3s;
        }
        .lab-field input:focus, .lab-field textarea:focus { border-color: var(--primary); background: white; outline: none; }
        
        /* å¯¦é©—ç´€éŒ„åˆ—è¡¨ */
        .exp-history-item { background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid var(--primary); font-size: 14px; }
        .exp-history-header { font-weight: bold; display: flex; justify-content: space-between; margin-bottom: 5px; color: var(--primary); }
        .exp-history-detail { color: #555; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }

        /* å¯¦é©—äºŒæŒ‰éˆ•ç¾¤çµ„ */
        .trial-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .trial-btn { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 8px; background: white; color: #666; font-weight: bold; }
        .trial-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        .topic-item { border: 1px solid #eee; padding: 15px; margin-bottom: 10px; border-radius: 12px; cursor: pointer; background: white; }
        .comment-item { background: #f9f9f9; padding: 12px 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid var(--secondary); }
        .comment-input-area { position: fixed; bottom: 60px; left: 0; width: 100%; background: white; padding: 10px; display: flex; gap: 10px; align-items: center; border-top: 1px solid #ddd; z-index: 900; }
        .comment-input-area input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; outline: none; }

        /* åº•éƒ¨å°èˆª */
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 1000; }
        .nav-item { text-align: center; font-size: 10px; color: #bbb; width: 20%; cursor: pointer; transition: 0.2s; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 4px; }

        .page { display: none; opacity: 0; animation: fadeIn 0.3s forwards; }
        .page.active { display: block; }
        @keyframes fadeIn { to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="color: var(--primary); margin-top: 0;">2026 å°å¤§ç”Ÿå·¥ç‡Ÿ</h2>
            <p style="color: #888; font-size: 14px; margin-bottom: 20px;">è«‹è¼¸å…¥å§“åèˆ‡èº«åˆ†è­‰å­—è™Ÿå¾Œå››ç¢¼</p>
            <input type="text" id="loginName" class="login-input" placeholder="å§“å (ä¾‹: ç‹å°æ˜)">
            <input type="text" id="loginID" class="login-input" placeholder="èº«åˆ†è­‰å­—è™Ÿå¾Œå››ç¢¼ (ä¾‹: 1234)">
            <button class="btn" onclick="handleLogin()">é€²å…¥ç‡ŸéšŠç³»çµ±</button>
        </div>
    </div>

    <div id="loading-mask">
        <i class="fas fa-spinner fa-spin" style="font-size: 40px; color: var(--primary); margin-bottom: 15px;"></i>
        <p>æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...</p>
    </div>

    <div id="app-container" style="display: none;">
        
        <div id="home" class="page active container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0;">Hi, <span id="user-name">å­¸å“¡</span> ğŸ‘‹</h2>
                <div onclick="toggleDevMode()" style="cursor:pointer; padding:5px;"><i class="fas fa-clock" style="color:#ddd;"></i></div>
            </div>

            <div class="card home-status-card" style="background: linear-gradient(135deg, var(--primary), #4DD0E1); color: white;" onclick="jumpToCurrentSchedule()">
                <div style="background: rgba(255,255,255,0.2); display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; margin-bottom: 10px;">ç¾åœ¨ç‹€æ…‹ (é»æ“ŠæŸ¥çœ‹)</div>
                <h3 id="home-status-title" style="margin: 0 0 5px 0; font-size: 24px;">è¼‰å…¥ä¸­...</h3>
                <p id="home-status-time" style="margin: 0; opacity: 0.9;">--:--</p>
            </div>

            <div class="card">
                <div style="display: flex; gap: 15px;">
                    <div style="flex: 1; text-align: center; background: #f9f9f9; padding: 10px; border-radius: 10px;">
                        <div style="font-size: 12px; color: #888;">å°éšŠ</div>
                        <div style="font-size: 20px; font-weight: bold; color: var(--text);">ç¬¬ <span id="info-group">--</span> å°</div>
                    </div>
                    <div style="flex: 1; text-align: center; background: #f9f9f9; padding: 10px; border-radius: 10px;">
                        <div style="font-size: 12px; color: #888;">æˆ¿è™Ÿ</div>
                        <div style="font-size: 20px; font-weight: bold; color: var(--primary);" id="info-room">--</div>
                    </div>
                </div>
            </div>

            <h3 style="margin-bottom: 10px; font-size: 18px;">ğŸ“¢ ç‡ŸéšŠå…¬å‘Š</h3>
            <div id="announcement-container"></div>
        </div>

        <div id="schedule" class="page container">
            <h2>ğŸ“… æ´»å‹•æ—¥ç¨‹</h2>
            <div class="day-tabs" id="day-tabs"></div>
            <div id="schedule-list"></div>
        </div>

        <div id="activity" class="page container">
            <h2>ğŸ† æˆ°æ³æ’è¡Œæ¦œ</h2>
            <div class="card" style="padding-top: 10px;">
                <div id="scoreboard">è¼‰å…¥ä¸­...</div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="card" style="text-align: center; cursor: pointer; margin-bottom:0;" onclick="openSubPage('experiment-page')">
                    <i class="fas fa-flask" style="font-size: 30px; color: var(--primary); margin-bottom: 10px;"></i>
                    <h3 style="font-size: 14px; margin:0;">å¯¦é©—ç´€éŒ„</h3>
                    <span style="font-size: 10px; color: #888;">å¡«å¯«å¯¦é©—æ•¸æ“š</span>
                </div>
                <div class="card" style="text-align: center; cursor: pointer; margin-bottom:0;" onclick="openSubPage('notes-page')">
                    <i class="fas fa-comments" style="font-size: 30px; color: var(--accent); margin-bottom: 10px;"></i>
                    <h3 style="font-size: 14px; margin:0;">æˆç™¼ç­†è¨˜</h3>
                    <span style="font-size: 10px; color: #888;">å°çµ„è¨è«–å€</span>
                </div>
            </div>
        </div>

        <div id="experiment-page" class="page container">
            <button class="back-btn" onclick="switchPage('activity', document.querySelectorAll('.nav-item')[2])">
                <i class="fas fa-chevron-left"></i> è¿”å›æ´»å‹•
            </button>
            <h2 style="color: var(--primary);">âš—ï¸ å¯¦é©—æ•¸æ“šç´€éŒ„</h2>
            
            <div class="card">
                <p style="font-size: 12px; color: #888; text-align: center; margin-bottom: 10px;">
                    ç¬¬ <b id="exp-group-num">?</b> å°çµ„
                </p>
                <div class="day-tabs">
                    <div class="day-tab active" id="tab-exp1" onclick="switchExpTab(1)">å¯¦é©—ä¸€: æ·¹æ°´æ¨¡æ“¬</div>
                    <div class="day-tab" id="tab-exp2" onclick="switchExpTab(2)">å¯¦é©—äºŒ: ç‰©ç†éæ¿¾</div>
                </div>

                <div id="exp1-container" style="display: block;">
                    
                    <div id="exp1-history-list" style="margin-top:15px; max-height: 200px; overflow-y: auto;">
                        </div>

                    <hr style="border:0; border-top:1px dashed #ddd; margin: 15px 0;">
                    
                    <h4 style="margin:0 0 10px 0; color:var(--primary);">â• æ–°å¢ä¸€ç­†æ•¸æ“š</h4>
                    <div class="lab-form">
                        <div class="lab-field" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div>
                                <label>æ²™åŒ…æ•¸é‡</label>
                                <input type="number" id="exp1-sandbag-count" placeholder="0">
                            </div>
                            <div>
                                <label>æŠ½æ°´æ©Ÿæ•¸é‡</label>
                                <input type="number" id="exp1-pump-count" placeholder="0">
                            </div>
                        </div>
                        <div class="lab-field">
                            <label>é…ç½®åº§æ¨™ (ä¾‹å¦‚: æ²™åŒ…(3,4), æŠ½æ°´(1,1))</label>
                            <input type="text" id="exp1-coords" placeholder="ç°¡è¿°åº§æ¨™ä½ç½®">
                        </div>
                        <div class="lab-field">
                            <label>ç¸½æ·¹æ°´é¢ç© (mÂ²)</label>
                            <input type="number" id="exp1-area" placeholder="è¼¸å…¥çµæœ">
                        </div>
                        <button class="btn" onclick="addExp1Record()">
                            <i class="fas fa-plus"></i> æ–°å¢æ­¤ç­†ç´€éŒ„
                        </button>
                    </div>
                </div>

                <div id="exp2-container" style="display: none;">
                    
                    <div class="trial-selector" style="margin-top: 15px;">
                        <button class="trial-btn active" id="trial-1-btn" onclick="switchExp2Trial(0)">ç¬¬ä¸€æ¬¡å˜—è©¦</button>
                        <button class="trial-btn" id="trial-2-btn" onclick="switchExp2Trial(1)">ç¬¬äºŒæ¬¡å˜—è©¦</button>
                    </div>

                    <div class="lab-form">
                        <div class="lab-field">
                            <label>éæ¿¾ä»‹è³ªçµ„åˆ (ä¾‹å¦‚: ç ‚+å°çŸ³+æ£‰èŠ±)</label>
                            <textarea id="exp2-media" rows="2" placeholder="ç”±ä¸Šè€Œä¸‹æè¿°..."></textarea>
                        </div>
                        <div class="lab-field">
                            <label>æ³¥æ°´é¡è‰²è®ŠåŒ–</label>
                            <input type="text" id="exp2-color" placeholder="ä¾‹å¦‚: æ·±è¤ -> æ·ºé»ƒ">
                        </div>
                        <div class="lab-field" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div>
                                <label>éæ¿¾å‰æ¿åº¦</label>
                                <input type="number" id="exp2-pre-turbidity" placeholder="NTU">
                            </div>
                            <div>
                                <label>éæ¿¾å¾Œæ¿åº¦</label>
                                <input type="number" id="exp2-post-turbidity" placeholder="NTU">
                            </div>
                        </div>
                        
                        <div style="font-size:10px; color:#888; text-align:right; margin-top:5px;" id="exp2-status">å°šæœªå„²å­˜</div>

                        <button class="btn" onclick="saveExp2Record()">
                            <i class="fas fa-save"></i> å„²å­˜æœ¬å˜—è©¦æ•¸æ“š
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <div id="notes-page" class="page container">
            <div id="topic-list-section">
                <button class="back-btn" onclick="switchPage('activity', document.querySelectorAll('.nav-item')[2])">
                    <i class="fas fa-chevron-left"></i> è¿”å›æ´»å‹•
                </button>
                <h2 id="discussion-header">ğŸ“Œ æˆç™¼ç­†è¨˜è¨è«–å€</h2>
                <div class="card" style="margin-bottom: 20px;">
                    <h4 style="margin-top:0; margin-bottom:10px;">ï¼‹ ç™¼èµ·æ–°è¨è«–</h4>
                    <input type="text" id="new-topic-title" placeholder="æ¨™é¡Œ..." style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px;">
                    <textarea id="new-topic-content" rows="2" placeholder="å…§å®¹..." style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;"></textarea>
                    <button class="btn" id="btn-create-topic" style="margin-top:10px;">ç™¼ä½ˆ</button>
                </div>
                <div id="topics-container">è¼‰å…¥ä¸­...</div>
            </div>

            <div id="discussion-section" style="display: none;">
                <button class="back-btn" id="btn-back-to-topics"><i class="fas fa-arrow-left"></i> å›åˆ—è¡¨</button>
                <div class="card">
                    <h2 id="view-topic-title" style="margin-bottom:10px;"></h2>
                    <p id="view-topic-content" style="white-space: pre-wrap; color:#333;"></p>
                    <div style="border-top:1px solid #eee; margin-top:10px; padding-top:10px; color:#888; font-size:12px;">
                        ç™¼èµ·äººï¼š<span id="view-topic-author"></span>
                    </div>
                </div>
                <h3>ğŸ’¬ ç•™è¨€æ¿</h3>
                <div id="comments-list" style="padding-bottom: 60px;"></div>
                <div class="comment-input-area">
                    <input type="text" id="my-comment" placeholder="è¼¸å…¥ç•™è¨€...">
                    <button id="btn-send-comment" style="background:var(--primary); color:white; border:none; width:40px; height:40px; border-radius:50%;"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <div id="info" class="page container">
            <h2>â„¹ï¸ å¯¦ç”¨è³‡è¨Š</h2>
            <div id="info-list"></div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchPage('home', this)"><i class="fas fa-home nav-icon"></i>é¦–é </div>
        <div class="nav-item" onclick="switchPage('schedule', this)"><i class="fas fa-calendar-alt nav-icon"></i>è¡Œç¨‹</div>
        <div class="nav-item" onclick="switchPage('activity', this)"><i class="fas fa-trophy nav-icon"></i>æ´»å‹•</div>
        <div class="nav-item" onclick="switchPage('info', this)"><i class="fas fa-info-circle nav-icon"></i>è³‡è¨Š</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, addDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCIrDF_HbcjgvafKfGRjF7VhB0pLpJO6W8",
            authDomain: "bse-camp.firebaseapp.com",
            projectId: "bse-camp",
            storageBucket: "bse-camp.firebasestorage.app",
            messagingSenderId: "287416151522",
            appId: "1:287416151522:web:435f09982f54943ba75dbb"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyw80JUzl6md7mEW8DqsIRojefbSjCeTLiXb67la7sTkS4CsmAJaEiU3cCuUzBnGmep/exec";

        // State
        let currentUser = { name: "å­¸å“¡", group: "1", room: "ç„¡" };
        let cachedData = JSON.parse(localStorage.getItem('bse_camp_data')) || null;
        let mockTime = null;
        let currentTabDay = "";
        let currentTopicId = null;
        let unsubscribeComments = null;
        let unsubscribeTopics = null;
        let statusInterval = null;
        
        // å¯¦é©—ç‹€æ…‹
        let currentExpTab = 1;
        let exp1Logs = []; // å­˜å¯¦é©—ä¸€çš„æ­·å²ç´€éŒ„ array
        let exp2Trials = [{}, {}]; // å­˜å¯¦é©—äºŒçš„å…©æ¬¡ç´€éŒ„
        let currentExp2TrialIndex = 0; // 0 æˆ– 1

        function cleanDate(raw) {
            if (!raw) return "";
            if (String(raw).includes('/') && String(raw).length < 6) return raw;
            const d = new Date(raw);
            if (isNaN(d.getTime())) return String(raw).substring(0, 5);
            const twTime = new Date(d.getTime() + (8 * 60 * 60 * 1000));
            return (twTime.getUTCMonth() + 1) + "/" + twTime.getUTCDate();
        }

        function cleanTime(raw) {
            if (!raw) return "--:--";
            const s = String(raw);
            if (s.includes("T") || s.length > 8) {
                const d = new Date(raw);
                const twTime = new Date(d.getTime() + (8 * 60 * 60 * 1000));
                return twTime.getUTCHours().toString().padStart(2,'0') + ":" + twTime.getUTCMinutes().toString().padStart(2,'0');
            }
            return s.substring(0, 5);
        }

        // ========================
        // 1. Login (Real Validation)
        // ========================
        window.handleLogin = async function() {
            const inputName = document.getElementById('loginName').value.trim();
            const inputID = document.getElementById('loginID').value.trim();
            
            if(!inputName || !inputID) {
                alert("è«‹è¼¸å…¥å§“åèˆ‡èº«åˆ†è­‰å­—è™Ÿ");
                return;
            }

            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('loading-mask').style.display = 'flex';

            await fetchData(); // Force fetch list

            const campersList = cachedData ? (cachedData.campers || []) : [];
            const user = campersList.find(c => c.name === inputName && String(c.id).toUpperCase() === inputID.toUpperCase());

            if (user) {
                currentUser = user;
                
                document.getElementById('loading-mask').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                
                document.getElementById('user-name').innerText = currentUser.name;
                document.getElementById('info-group').innerText = currentUser.group;
                document.getElementById('info-room').innerText = currentUser.room;
                document.getElementById('exp-group-num').innerText = currentUser.group;
                document.getElementById('discussion-header').innerText = `ğŸ“Œ ç¬¬ ${currentUser.group} å°çµ„æˆç™¼ç­†è¨˜`;

                initGroupSync(currentUser.group);
                initDiscussion(currentUser.group);
                renderAll();
                
                alert(`æ­¡è¿å›ä¾†ï¼Œ${user.name}ï¼\nä½ è¢«åˆ†é…åœ¨ç¬¬ ${user.group} å°éšŠ`);
            } else {
                document.getElementById('loading-mask').style.display = 'none';
                document.getElementById('login-overlay').style.display = 'flex';
                alert("ç™»å…¥å¤±æ•—ï¼è«‹æª¢æŸ¥å§“åæˆ–èº«åˆ†è­‰æ˜¯å¦æ­£ç¢ºã€‚");
            }
        };

        async function fetchData() {
            try {
                const res = await fetch(GOOGLE_SCRIPT_URL);
                const data = await res.json();
                cachedData = data;
                localStorage.setItem('bse_camp_data', JSON.stringify(data));
            } catch (e) {
                console.error(e);
                if(!cachedData) alert("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
            }
        }

        function renderAll() {
            if (!cachedData) return;
            renderAnnouncements();
            renderScoreboard();
            renderInfo();
            initSchedule();
        }

        // ========================
        // 2. Rendering
        // ========================
        
        function renderAnnouncements() {
            const list = (cachedData.announcements || []).filter(a => String(a.active).toLowerCase() === "true");
            document.getElementById('announcement-container').innerHTML = list.length ? list.map(a => {
                const isUrgent = String(a.urgent).toLowerCase() === "true";
                return `
                <div class="card ${isUrgent ? 'urgent' : ''}">
                    <h3 style="margin:0 0 5px 0; color:${isUrgent ? 'var(--urgent)' : 'var(--text)'};">
                        ${isUrgent ? 'ğŸš¨ ' : 'ğŸ“Œ '}${a.title}
                    </h3>
                    <p style="margin:0;">${a.content}</p>
                    <div style="font-size:12px; color:#aaa; margin-top:8px; text-align:right;">${cleanDate(a.date)}</div>
                </div>`;
            }).join('') : `<div class="card" style="color:#888;">ç›®å‰ç„¡å…¬å‘Š</div>`;
        }

        function initSchedule() {
            const list = cachedData.schedule || [];
            if(list.length === 0) return;

            const days = [...new Set(list.map(i => cleanDate(i.day)))];
            const now = mockTime || new Date();
            const todayStr = (now.getMonth() + 1) + "/" + now.getDate();
            
            if(!currentTabDay) {
                currentTabDay = days.includes(todayStr) ? todayStr : days[0];
            }

            document.getElementById('day-tabs').innerHTML = days.map(d => 
                `<div class="day-tab ${d===currentTabDay?'active':''}" onclick="setTab('${d}')">${d}</div>`
            ).join('');
            
            renderScheduleList();
            updateLiveStatus();
            
            if(statusInterval) clearInterval(statusInterval);
            statusInterval = setInterval(() => {
                renderScheduleList(); 
                updateLiveStatus();
            }, 60000);
        }

        window.setTab = function(d) {
            currentTabDay = d;
            document.querySelectorAll('.day-tab').forEach(t => {
                if(t.innerText === d) t.classList.add('active');
                else t.classList.remove('active');
            });
            renderScheduleList();
        }

        window.jumpToCurrentSchedule = function() {
            const now = mockTime || new Date();
            const todayStr = (now.getMonth() + 1) + "/" + now.getDate();
            switchPage('schedule', document.querySelectorAll('.nav-item')[1]);
            
            const list = cachedData.schedule || [];
            const days = [...new Set(list.map(i => cleanDate(i.day)))];
            
            if (days.includes(todayStr)) setTab(todayStr);
            else if (days.length > 0) setTab(days[0]);
        };

        function renderScheduleList() {
            const list = cachedData.schedule || [];
            const dayEvents = list
                .filter(i => cleanDate(i.day) === currentTabDay)
                .sort((a, b) => {
                    const tA = cleanTime(a.time).split(':');
                    const tB = cleanTime(b.time).split(':');
                    return (parseInt(tA[0])*60 + parseInt(tA[1])) - (parseInt(tB[0])*60 + parseInt(tB[1]));
                });
            
            const now = mockTime || new Date();
            const nowVal = now.getHours() * 60 + now.getMinutes();
            const isToday = cleanDate(now) === currentTabDay;

            document.getElementById('schedule-list').innerHTML = dayEvents.map((e, index) => {
                const timeStr = cleanTime(e.time);
                const [h, m] = timeStr.split(':');
                const startVal = parseInt(h) * 60 + parseInt(m);
                
                let endVal;
                if (index < dayEvents.length - 1) {
                    const nextTimeStr = cleanTime(dayEvents[index + 1].time);
                    const [nh, nm] = nextTimeStr.split(':');
                    endVal = parseInt(nh) * 60 + parseInt(nm);
                } else {
                    endVal = startVal + 60; 
                }
                
                const isActive = isToday && (nowVal >= startVal && nowVal < endVal);
                const isPast = (isToday && nowVal >= endVal) || (cleanDate(now) > currentTabDay && !isToday && cleanDate(now) != currentTabDay);

                let statusClass = '';
                let statusLabel = '';
                
                if (isActive) {
                    statusClass = 'active-now';
                    statusLabel = '<span style="color:red;font-size:12px;margin-left:5px;">(é€²è¡Œä¸­)</span>';
                } else if (isPast) {
                    statusClass = 'past';
                }

                return `
                <div class="schedule-item ${statusClass}">
                    <div class="time-badge">${timeStr}</div>
                    <div style="flex:1;">
                        <div style="font-weight:bold;">${e.title} ${statusLabel}</div>
                        <div style="font-size:13px; color:#888;">ğŸ“ ${e.loc}</div>
                    </div>
                </div>`;
            }).join('');
        }

        function updateLiveStatus() {
            const now = mockTime || new Date();
            const nowVal = now.getHours() * 60 + now.getMinutes();
            const todayStr = (now.getMonth() + 1) + "/" + now.getDate();
            
            const list = cachedData.schedule || [];
            const todayEvents = list
                .filter(i => cleanDate(i.day) === todayStr)
                .sort((a, b) => {
                    const tA = cleanTime(a.time).split(':');
                    const tB = cleanTime(b.time).split(':');
                    return (parseInt(tA[0])*60 + parseInt(tA[1])) - (parseInt(tB[0])*60 + parseInt(tB[1]));
                });

            const current = todayEvents.find((e, index) => {
                const [h, m] = cleanTime(e.time).split(':');
                const startVal = parseInt(h)*60 + parseInt(m);
                let endVal;
                if (index < todayEvents.length - 1) {
                    const [nh, nm] = cleanTime(todayEvents[index + 1].time).split(':');
                    endVal = parseInt(nh) * 60 + parseInt(nm);
                } else {
                    endVal = startVal + 60;
                }
                return nowVal >= startVal && nowVal < endVal;
            });

            if (current) {
                document.getElementById('home-status-title').innerText = current.title;
                document.getElementById('home-status-time').innerText = `æ­£åœ¨é€²è¡Œ (${current.loc})`;
            } else {
                document.getElementById('home-status-title').innerText = "ç›®å‰ç„¡æ´»å‹•";
                document.getElementById('home-status-time').innerText = "ä¼‘æ¯ä¸­";
            }
        }

        function renderScoreboard() {
            let list = cachedData.scores || [];
            if(list.length === 0) { document.getElementById('scoreboard').innerHTML = "å°šç„¡è³‡æ–™"; return; }
            
            list.sort((a, b) => b.score - a.score);
            const max = list[0].score || 100;

            document.getElementById('scoreboard').innerHTML = list.map((s, index) => {
                const rankClass = index < 3 ? `rank-${index+1}` : '';
                let medal = '';
                if(index === 0) medal = 'ğŸ¥‡ ';
                if(index === 1) medal = 'ğŸ¥ˆ ';
                if(index === 2) medal = 'ğŸ¥‰ ';

                return `
                <div class="score-row ${rankClass}">
                    <div class="rank-badge">${index + 1}</div>
                    <div class="group-info">
                        <span class="group-medal">${medal}</span>
                        <span class="group-name">ç¬¬ ${s.id} å°éšŠ</span>
                    </div>
                    <div class="score-bar-bg">
                        <div class="score-bar-fill" style="width: ${(s.score/max)*100}%"></div>
                    </div>
                    <div class="score-num">${s.score}</div>
                </div>`;
            }).join('');
        }

        function renderInfo() {
            const list = cachedData.info || [];
            document.getElementById('info-list').innerHTML = list.map(i => {
                const title = i.title || i.Title || "æ¨™é¡Œ";
                const type = (i.type || i.Type || "").toLowerCase();
                const val = i.value || i.Value || "";
                
                let btn = "";
                if(type === 'tel' && val) btn = `<button class="btn" onclick="location.href='tel:${val}'"><i class="fas fa-phone"></i> æ’¥æ‰“</button>`;
                if(type === 'link' && val) btn = `<button class="btn btn-secondary" onclick="window.open('${val}')"><i class="fas fa-link"></i> é–‹å•Ÿé€£çµ</button>`;

                return `
                <div class="card">
                    <h3 style="margin:0 0 5px 0;">${title}</h3>
                    <p style="color:#555; margin:0 0 ${btn?'15px':'0'} 0;">${i.content||""}</p>
                    ${btn}
                </div>`;
            }).join('');
        }

        // ========================
        // 3. Firebase & Experiment Logic
        // ========================
        
        // å¯¦é©— Tab åˆ‡æ› (å¯¦é©— 1 vs å¯¦é©— 2)
        window.switchExpTab = function(expId) {
            currentExpTab = expId;
            document.getElementById('tab-exp1').classList.toggle('active', expId === 1);
            document.getElementById('tab-exp2').classList.toggle('active', expId === 2);
            document.getElementById('exp1-container').style.display = expId === 1 ? 'block' : 'none';
            document.getElementById('exp2-container').style.display = expId === 2 ? 'block' : 'none';
        };

        // å¯¦é©— 2 çš„å˜—è©¦åˆ‡æ› (Trial 1 vs Trial 2)
        window.switchExp2Trial = function(index) {
            currentExp2TrialIndex = index;
            document.getElementById('trial-1-btn').classList.toggle('active', index === 0);
            document.getElementById('trial-2-btn').classList.toggle('active', index === 1);
            
            // è®€å–è©²æ¬¡å˜—è©¦çš„æ•¸æ“šä¸¦å¡«å…¥è¡¨å–®
            const data = exp2Trials[index] || {};
            document.getElementById('exp2-media').value = data.media || "";
            document.getElementById('exp2-color').value = data.color || "";
            document.getElementById('exp2-pre-turbidity').value = data.preTurb || "";
            document.getElementById('exp2-post-turbidity').value = data.postTurb || "";
        };

        function initGroupSync(groupId) {
            onSnapshot(doc(db, "groups", "group_" + groupId), (docSnap) => {
                if (docSnap.exists()) {
                    const d = docSnap.data();
                    
                    // 1. è¼‰å…¥å¯¦é©—ä¸€ (Logs é™£åˆ—)
                    exp1Logs = d.exp1_logs || [];
                    renderExp1Logs();

                    // 2. è¼‰å…¥å¯¦é©—äºŒ (Trials é™£åˆ—, å›ºå®šé•·åº¦ 2)
                    exp2Trials = d.exp2_logs || [{}, {}];
                    // åˆ·æ–°ç›®å‰é¡¯ç¤ºçš„ Trial è¡¨å–®
                    switchExp2Trial(currentExp2TrialIndex); 
                    
                    if(d.labLastEditor) document.getElementById('exp2-status').innerText = `æœ€å¾Œæ›´æ–°: ${d.labLastEditor}`;
                }
            });
        }

        // æ¸²æŸ“å¯¦é©—ä¸€çš„æ­·å²ç´€éŒ„åˆ—è¡¨
        function renderExp1Logs() {
            const list = document.getElementById('exp1-history-list');
            if (exp1Logs.length === 0) {
                list.innerHTML = "<p style='color:#999; text-align:center;'>å°šæœªæœ‰ç´€éŒ„</p>";
                return;
            }
            list.innerHTML = exp1Logs.map((log, i) => `
                <div class="exp-history-item">
                    <div class="exp-history-header">
                        <span>#${i+1} ç´€éŒ„</span>
                        <span style="font-size:12px; font-weight:normal;">é¢ç©: ${log.area} mÂ²</span>
                    </div>
                    <div class="exp-history-detail">
                        <span>æ²™åŒ…: ${log.sandbagCount} å€‹</span>
                        <span>æŠ½æ°´: ${log.pumpCount} å€‹</span>
                        <span style="grid-column: span 2; font-size:12px;">ğŸ“ ${log.coords}</span>
                    </div>
                </div>
            `).join('');
            // æ²å‹•åˆ°åº•éƒ¨
            list.scrollTop = list.scrollHeight;
        }

        // æ–°å¢å¯¦é©—ä¸€ç´€éŒ„ (Append)
        window.addExp1Record = async function() {
            const countS = document.getElementById('exp1-sandbag-count').value;
            const countP = document.getElementById('exp1-pump-count').value;
            const coords = document.getElementById('exp1-coords').value;
            const area = document.getElementById('exp1-area').value;

            if(!area) return alert("è«‹è¼¸å…¥æ·¹æ°´é¢ç©");

            const newLog = {
                sandbagCount: countS,
                pumpCount: countP,
                coords: coords,
                area: area,
                timestamp: new Date().toISOString()
            };

            // è¤‡è£½èˆŠé™£åˆ—ä¸¦åŠ å…¥æ–°ç´€éŒ„
            const updatedLogs = [...exp1Logs, newLog];

            try {
                await setDoc(doc(db, "groups", "group_" + currentUser.group), {
                    exp1_logs: updatedLogs,
                    labLastEditor: currentUser.name
                }, { merge: true });
                
                alert("æ–°å¢æˆåŠŸï¼");
                // æ¸…ç©ºè¼¸å…¥
                document.getElementById('exp1-area').value = "";
                document.getElementById('exp1-coords').value = "";
            } catch(e) { console.error(e); alert("æ–°å¢å¤±æ•—"); }
        };

        // å„²å­˜å¯¦é©—äºŒç´€éŒ„ (Update specific index)
        window.saveExp2Record = async function() {
            const data = {
                media: document.getElementById('exp2-media').value,
                color: document.getElementById('exp2-color').value,
                preTurb: document.getElementById('exp2-pre-turbidity').value,
                postTurb: document.getElementById('exp2-post-turbidity').value
            };

            // æ›´æ–°æœ¬åœ°é™£åˆ—çš„ç‰¹å®šä½ç½®
            exp2Trials[currentExp2TrialIndex] = data;

            try {
                await setDoc(doc(db, "groups", "group_" + currentUser.group), {
                    exp2_logs: exp2Trials,
                    labLastEditor: currentUser.name
                }, { merge: true });
                alert("å„²å­˜æˆåŠŸï¼");
            } catch(e) { console.error(e); alert("å„²å­˜å¤±æ•—"); }
        };

        function initDiscussion(groupId) {
            if(unsubscribeTopics) unsubscribeTopics();
            const ref = collection(db, "groups", "group_" + groupId, "topics");
            unsubscribeTopics = onSnapshot(query(ref, orderBy("createdAt", "desc")), (snap) => {
                const con = document.getElementById("topics-container");
                if(snap.empty) { con.innerHTML = "<p style='color:#ccc;text-align:center;'>ç„¡è¨è«–</p>"; return; }
                con.innerHTML = "";
                snap.forEach(d => {
                    const div = document.createElement("div");
                    div.className = "topic-item";
                    div.innerHTML = `<h3>${d.data().title}</h3><p style="color:#666;font-size:13px;margin:0;">${d.data().content}</p>`;
                    div.onclick = () => openDiscussion(d.id, d.data());
                    con.appendChild(div);
                });
            });
        }

        function openDiscussion(docId, data) {
            currentTopicId = docId;
            document.getElementById("topic-list-section").style.display = "none";
            document.getElementById("discussion-section").style.display = "block";
            document.getElementById("view-topic-title").innerText = data.title;
            document.getElementById("view-topic-content").innerText = data.content;
            document.getElementById("view-topic-author").innerText = data.author;
            
            if(unsubscribeComments) unsubscribeComments();
            const ref = collection(db, "groups", "group_" + currentUser.group, "topics", docId, "comments");
            unsubscribeComments = onSnapshot(query(ref, orderBy("createdAt", "asc")), (snap) => {
                const list = document.getElementById("comments-list");
                list.innerHTML = "";
                snap.forEach(c => {
                    const div = document.createElement("div");
                    div.className = "comment-item";
                    div.innerHTML = `<div style="font-size:12px;color:#888;">${c.data().user}</div><div>${c.data().message}</div>`;
                    list.appendChild(div);
                });
                window.scrollTo(0, document.body.scrollHeight);
            });
        }

        document.getElementById("btn-create-topic").onclick = async () => {
            const t = document.getElementById("new-topic-title").value;
            const c = document.getElementById("new-topic-content").value;
            if(!t) return;
            await addDoc(collection(db, "groups", "group_" + currentUser.group, "topics"), {
                title: t, content: c, author: currentUser.name, createdAt: serverTimestamp()
            });
            document.getElementById("new-topic-title").value = ""; document.getElementById("new-topic-content").value = "";
        };

        document.getElementById("btn-send-comment").onclick = async () => {
            const m = document.getElementById("my-comment").value;
            if(!m) return;
            await addDoc(collection(db, "groups", "group_" + currentUser.group, "topics", currentTopicId, "comments"), {
                user: currentUser.name, message: m, createdAt: serverTimestamp()
            });
            document.getElementById("my-comment").value = "";
        };

        document.getElementById("btn-back-to-topics").onclick = () => {
            document.getElementById("discussion-section").style.display = "none";
            document.getElementById("topic-list-section").style.display = "block";
        };

        // ========================
        // 4. å°èˆª
        // ========================
        window.switchPage = function(pageId, navEl) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            if(navEl) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                navEl.classList.add('active');
            }
        };

        window.openSubPage = function(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.nav-item')[2].classList.add('active');
        };

        window.toggleDevMode = function() {
            const t = prompt("è¨­å®šæ™‚é–“ (æ ¼å¼: 1/26 14:00)");
            if(t) {
                mockTime = new Date(`2026/${t}:00`);
                initSchedule();
                renderScoreboard();
                alert("æ™‚é–“å·²è¨­å®š: " + t);
            }
        };
    </script>
</body>
</html>
