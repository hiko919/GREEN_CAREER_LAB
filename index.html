<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 å°å¤§ç”Ÿå·¥ç‡Ÿ | æ­£å¼ç‰ˆ</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- è¨­è¨ˆç³»çµ± (Design System) --- */
        :root {
            --primary: #2AB7CA; 
            --primary-dark: #239cb0;
            --secondary: #76C95A; 
            --accent: #FF9F1C; 
            --urgent: #e63946; /* ç·Šæ€¥å…¬å‘Šç´… */
            --bg: #F4F7F6;
            --text: #333;
            --card-bg: #FFFFFF;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: 0; padding-bottom: 90px; overflow-x: hidden;
        }

        /* å…±ç”¨å®¹å™¨èˆ‡å¡ç‰‡ */
        .container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .card {
            background: var(--card-bg); border-radius: 16px; padding: 20px;
            margin-bottom: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.02); position: relative;
            transition: transform 0.2s;
        }
        
        /* ğŸš¨ ç·Šæ€¥å…¬å‘Šç‰¹æ•ˆ */
        .card.urgent { border: 2px solid var(--urgent); animation: border-pulse 2s infinite; }
        @keyframes border-pulse { 0% { border-color: var(--urgent); box-shadow: 0 0 5px rgba(230,57,70,0.2); } 50% { border-color: #ffb3b8; box-shadow: 0 0 15px rgba(230,57,70,0.4); } 100% { border-color: var(--urgent); box-shadow: 0 0 5px rgba(230,57,70,0.2); } }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            background: var(--primary); color: white; border: none; padding: 12px; border-radius: 12px;
            font-size: 16px; font-weight: bold; width: 100%; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn:active { transform: scale(0.98); }
        .btn-secondary { background: var(--secondary); }
        .back-btn { background: none; border: none; font-size: 16px; color: #666; cursor: pointer; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }

        /* ç™»å…¥é é¢ */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px;
        }
        .login-box { background: white; width: 100%; max-width: 320px; padding: 30px; border-radius: 24px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .login-input { width: 100%; padding: 12px; margin-bottom: 12px; border: 2px solid #eee; border-radius: 10px; font-size: 16px; outline: none; }

        /* Loading é®ç½© */
        #loading-mask {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 8000;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }

        /* è¡Œç¨‹è¡¨ Tab æ¨£å¼ */
        .day-tabs { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; scrollbar-width: none; }
        .day-tabs::-webkit-scrollbar { display: none; }
        .day-tab {
            background: white; color: #888; padding: 8px 16px; border-radius: 20px;
            font-size: 14px; white-space: nowrap; border: 1px solid #eee; cursor: pointer;
        }
        .day-tab.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(42, 183, 202, 0.3); }

        .schedule-item { display: flex; align-items: flex-start; gap: 15px; padding: 15px; border-radius: 12px; background: white; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .schedule-item.active-now { border: 2px solid var(--primary); background: #f0fdff; }
        .time-badge { background: rgba(42, 183, 202, 0.1); color: var(--primary); padding: 5px 8px; border-radius: 6px; font-weight: bold; font-size: 14px; min-width: 65px; text-align: center; }

        /* å¯¦é©—èˆ‡è¨è«–å€ */
        .lab-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .lab-field { display: flex; flex-direction: column; }
        .lab-field label { font-size: 12px; color: #666; margin-bottom: 5px; font-weight: bold; }
        .lab-field input, .lab-field textarea { padding: 10px; border: 2px solid #eee; border-radius: 8px; font-size: 16px; text-align: center; background: #FAFAFA; width: 100%; }
        .lab-field textarea { text-align: left; resize: none; }

        .topic-item { border: 1px solid #eee; padding: 15px; margin-bottom: 10px; border-radius: 12px; cursor: pointer; background: white; }
        .comment-item { background: #f9f9f9; padding: 12px 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid var(--secondary); }
        .comment-input-area { position: fixed; bottom: 60px; left: 0; width: 100%; background: white; padding: 10px; display: flex; gap: 10px; align-items: center; border-top: 1px solid #ddd; z-index: 900; }
        .comment-input-area input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; outline: none; }

        /* åº•éƒ¨å°èˆª */
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 1000; }
        .nav-item { text-align: center; font-size: 10px; color: #bbb; width: 20%; cursor: pointer; transition: 0.2s; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 4px; }

        /* é é¢åˆ‡æ›å‹•ç•« */
        .page { display: none; opacity: 0; animation: fadeIn 0.3s forwards; }
        .page.active { display: block; }
        @keyframes fadeIn { to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <div style="font-size: 40px; margin-bottom: 10px; color: var(--primary);"><i class="fas fa-water"></i></div>
            <h2 style="color: var(--primary); margin-top: 0;">2026 å°å¤§ç”Ÿå·¥ç‡Ÿ</h2>
            <p style="color: #888; font-size: 14px; margin-bottom: 20px;">è«‹è¼¸å…¥å§“åèˆ‡å­¸å“¡ç·¨è™Ÿ</p>
            <input type="text" id="loginName" class="login-input" placeholder="å­¸å“¡å§“å (ä¾‹: ç‹å°æ˜)">
            <input type="text" id="loginID" class="login-input" placeholder="å­¸å“¡ç·¨è™Ÿ (ä¾‹: 101)">
            <button class="btn" onclick="handleLogin()">é€²å…¥ç‡ŸéšŠç³»çµ±</button>
        </div>
    </div>

    <div id="loading-mask">
        <i class="fas fa-spinner fa-spin" style="font-size: 40px; color: var(--primary); margin-bottom: 15px;"></i>
        <p id="loading-text" style="color:#555;">æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...</p>
    </div>

    <div id="app-container" style="display: none;">
        
        <div id="home" class="page active container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0;">Hi, <span id="user-name">å­¸å“¡</span> ğŸ‘‹</h2>
                <div onclick="toggleDevMode()" style="background:white; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 5px rgba(0,0,0,0.1); cursor:pointer;">
                    <i class="fas fa-clock" style="color:var(--primary);"></i>
                </div>
            </div>

            <div class="card" style="background: linear-gradient(135deg, var(--primary), #4DD0E1); color: white;">
                <div style="background: rgba(255,255,255,0.2); display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; margin-bottom: 10px;">
                    <i class="fas fa-bullhorn"></i> ç¾åœ¨ç‹€æ…‹
                </div>
                <h3 id="home-status-title" style="margin: 0 0 5px 0; font-size: 24px;">è¼‰å…¥ä¸­...</h3>
                <p id="home-status-time" style="margin: 0; opacity: 0.9;">--:--</p>
            </div>

            <div class="card">
                <div style="display: flex; gap: 15px;">
                    <div style="flex: 1; text-align: center; background: #f9f9f9; padding: 10px; border-radius: 10px;">
                        <div style="font-size: 12px; color: #888;">å°éšŠ</div>
                        <div style="font-size: 20px; font-weight: bold; color: var(--text);" id="info-group">--</div>
                    </div>
                    <div style="flex: 1; text-align: center; background: #f9f9f9; padding: 10px; border-radius: 10px;">
                        <div style="font-size: 12px; color: #888;">æˆ¿è™Ÿ</div>
                        <div style="font-size: 20px; font-weight: bold; color: var(--primary);" id="info-room">--</div>
                    </div>
                </div>
            </div>

            <h3 style="margin-bottom: 10px; font-size: 18px;">ğŸ“¢ ç‡ŸéšŠå…¬å‘Š</h3>
            <div id="announcement-container"></div>
        </div>

        <div id="schedule" class="page container">
            <h2>ğŸ“… æ´»å‹•æ—¥ç¨‹</h2>
            <div class="day-tabs" id="day-tabs"></div>
            <div id="schedule-list"></div>
        </div>

        <div id="activity" class="page container">
            <h2>ğŸ† æˆ°æ³æ’è¡Œæ¦œ</h2>
            <div class="card">
                <p style="font-size: 12px; color: #888; text-align: center; margin-bottom: 15px;">æ•¸æ“šä¾†è‡ªé›²ç«¯å³æ™‚æ›´æ–°</p>
                <div id="scoreboard">è¼‰å…¥ä¸­...</div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="card" style="text-align: center; cursor: pointer; margin-bottom:0;" onclick="openSubPage('experiment-page')">
                    <i class="fas fa-flask" style="font-size: 30px; color: var(--primary); margin-bottom: 10px;"></i>
                    <h3 style="font-size: 14px; margin:0;">å¯¦é©—ç´€éŒ„</h3>
                    <span style="font-size: 10px; color: #888;">ä¸Šå‚³æ°´è³ªæ•¸æ“š</span>
                </div>
                <div class="card" style="text-align: center; cursor: pointer; margin-bottom:0;" onclick="openSubPage('notes-page')">
                    <i class="fas fa-comments" style="font-size: 30px; color: var(--accent); margin-bottom: 10px;"></i>
                    <h3 style="font-size: 14px; margin:0;">æˆç™¼ç­†è¨˜</h3>
                    <span style="font-size: 10px; color: #888;">å°çµ„è¨è«–å€</span>
                </div>
            </div>
        </div>

        <div id="experiment-page" class="page container">
            <button class="back-btn" onclick="switchPage('activity', document.querySelector('.nav-item:nth-child(3)'))">
                <i class="fas fa-chevron-left"></i> è¿”å›æ´»å‹•
            </button>
            <h2 style="color: var(--primary);">âš—ï¸ æ°´è³ªæª¢æ¸¬ç´€éŒ„</h2>
            <div class="card">
                <p style="font-size: 12px; color: #888; text-align: center; margin-bottom: 15px;">
                    ç¬¬ <b id="exp-group-num">?</b> å°çµ„æ•¸æ“š (åŒæ­¥ä¸­)
                </p>
                
                <div class="lab-form">
                    <div class="lab-field"><label>pH é…¸é¹¼å€¼</label><input type="number" id="lab-ph" step="0.1" placeholder="7.0"></div>
                    <div class="lab-field"><label>æ°´æº« Temp.</label><input type="number" id="lab-temp" step="0.1" placeholder="25.0"></div>
                    <div class="lab-field"><label>å°é›»åº¦ EC</label><input type="number" id="lab-ec" placeholder="200"></div>
                    <div class="lab-field"><label>æ¿åº¦ Turbidity</label><input type="number" id="lab-tb" placeholder="5.0"></div>
                </div>

                <div class="lab-field" style="margin-top: 15px;">
                    <label>è§€å¯Ÿèˆ‡å‚™è¨»</label>
                    <textarea id="lab-note" style="height:80px;" placeholder="æ°´é«”é¡è‰²ã€æ°£å‘³ã€æ¡æ¨£åœ°é»..."></textarea>
                </div>

                <div style="font-size:10px; color:#888; text-align:right; margin: 10px 0;" id="exp-status">å°šæœªå„²å­˜</div>
                
                <button class="btn" onclick="saveLabData()" id="exp-btn">
                    <i class="fas fa-cloud-upload-alt"></i> ä¸Šå‚³æ•¸æ“š
                </button>
            </div>
        </div>

        <div id="notes-page" class="page container">
            <div id="topic-list-section">
                <button class="back-btn" onclick="switchPage('activity', document.querySelector('.nav-item:nth-child(3)'))">
                    <i class="fas fa-chevron-left"></i> è¿”å›é¸å–®
                </button>

                <h2 id="discussion-header">ğŸ“Œ æˆç™¼ç­†è¨˜è¨è«–å€</h2>
                
                <div class="card" style="margin-bottom: 20px;">
                    <h4 style="margin-top:0; margin-bottom:10px;">ï¼‹ ç™¼èµ·æ–°è¨è«–</h4>
                    <p style="font-size:12px; color:#666; margin-bottom:5px;">ç™¼èµ·äººï¼š<span id="new-topic-author" style="font-weight:bold; color:var(--primary);"></span></p>
                    <input type="text" id="new-topic-title" placeholder="æ¨™é¡Œ (ä¾‹: å¯¦é©—çµæœæ€ªæ€ªçš„)" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px;">
                    <textarea id="new-topic-content" rows="3" placeholder="è«‹è©³ç´°æè¿°å•é¡Œ..." style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px;"></textarea>
                    <button class="btn" id="btn-create-topic" style="margin-top:10px; font-size:14px;">ç™¼ä½ˆä¸»é¡Œ</button>
                </div>

                <div id="topics-container">
                    <p style="text-align:center; color:#999;">æ­£åœ¨è¼‰å…¥å°çµ„è¨è«–ä¸²...</p>
                </div>
            </div>

            <div id="discussion-section" style="display: none;">
                <button class="back-btn" id="btn-back-to-topics">
                    <i class="fas fa-arrow-left"></i> å›è¨è«–åˆ—è¡¨
                </button>
                
                <div class="card" id="current-topic-display">
                    <h2 id="view-topic-title" style="margin-bottom:10px;"></h2>
                    <p id="view-topic-content" style="white-space: pre-wrap; color:#333;"></p>
                    <div style="border-top:1px solid #eee; margin-top:10px; padding-top:10px; color:#888; font-size:12px;">
                        ç™¼èµ·äººï¼š<span id="view-topic-author" style="font-weight:bold;"></span>
                    </div>
                </div>

                <h3>ğŸ’¬ å°çµ„ç•™è¨€æ¿</h3>
                <div id="comments-list" style="padding-bottom: 60px;"></div>

                <div class="comment-input-area">
                    <span id="comment-user-badge" style="background:var(--primary); color:white; padding:5px 10px; border-radius:15px; font-size:12px; white-space:nowrap;">æˆ‘</span>
                    <input type="text" id="my-comment" placeholder="è¼¸å…¥ç•™è¨€...">
                    <button id="btn-send-comment" style="background:var(--primary); color:white; border:none; width:40px; height:40px; border-radius:50%; cursor:pointer;"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <div id="info" class="page container">
            <h2>â„¹ï¸ å¯¦ç”¨è³‡è¨Š</h2>
            <div id="info-list"></div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchPage('home', this)"><i class="fas fa-home nav-icon"></i>é¦–é </div>
        <div class="nav-item" onclick="switchPage('schedule', this)"><i class="fas fa-calendar-alt nav-icon"></i>è¡Œç¨‹</div>
        <div class="nav-item" onclick="switchPage('activity', this)"><i class="fas fa-trophy nav-icon"></i>æ´»å‹•</div>
        <div class="nav-item" onclick="switchPage('info', this)"><i class="fas fa-info-circle nav-icon"></i>è³‡è¨Š</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, doc, setDoc, updateDoc, arrayUnion, onSnapshot, 
            collection, addDoc, query, orderBy, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 1. Firebase è¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyCIrDF_HbcjgvafKfGRjF7VhB0pLpJO6W8",
            authDomain: "bse-camp.firebaseapp.com",
            projectId: "bse-camp",
            storageBucket: "bse-camp.firebasestorage.app",
            messagingSenderId: "287416151522",
            appId: "1:287416151522:web:435f09982f54943ba75dbb"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // 2. Google Sheets API (ä½ çš„æ–°ç¶²å€)
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby5gNCBcAO5ktMfLh1wU4ajjJJCDW8V1hx8ykzr7o6VJpqCLa6OFhiZxAw9JmpNsH4q/exec";

        // å…¨åŸŸè®Šæ•¸
        let currentUser = { name: "å­¸å“¡", group: "1", room: "ç„¡" };
        let cachedData = JSON.parse(localStorage.getItem('bse_camp_data')) || null;
        let mockTime = null;
        let currentTabDay = "";
        let currentTopicId = null;
        let unsubscribeComments = null;
        let unsubscribeTopics = null;

        // å­¸å“¡åå–® (å‡è³‡æ–™ï¼Œå¯¦éš›å¯æ”¹ç‚ºå¾ Sheet è®€å–)
        const campersDB = [
            { name: "ç‹å°æ˜", id: "101", group: "1", room: "501" },
            { name: "é™³å°ç¾", id: "102", group: "1", room: "502" },
            { name: "æ¸¬è©¦å“¡", id: "000", group: "2", room: "VIP" }
        ];

        // ==========================================
        //  A. ç™»å…¥èˆ‡è³‡æ–™åŒæ­¥
        // ==========================================
        window.handleLogin = async function() {
            const name = document.getElementById('loginName').value;
            const id = document.getElementById('loginID').value;
            
            // ç°¡å–®é©—è­‰
            const user = campersDB.find(c => c.name === name || c.id === id) || { name: name || "å­¸å“¡", group: "1", room: "?" };
            currentUser = user;

            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('loading-mask').style.display = 'flex';

            // å˜—è©¦æŠ“å–è³‡æ–™
            await fetchSheetData();

            // æ›´æ–° UI
            document.getElementById('loading-mask').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            
            updateUserInfo();
            initGroupSync(currentUser.group);
            initDiscussion(currentUser.group);
            renderAll();
        };

        function updateUserInfo() {
            document.getElementById('user-name').innerText = currentUser.name;
            document.getElementById('info-group').innerText = currentUser.group;
            document.getElementById('info-room').innerText = currentUser.room;
            document.getElementById('new-topic-author').innerText = currentUser.name;
            document.getElementById('comment-user-badge').innerText = currentUser.name;
            document.getElementById('discussion-header').innerText = `ğŸ“Œ ç¬¬ ${currentUser.group} å°çµ„æˆç™¼ç­†è¨˜`;
        }

        async function fetchSheetData() {
            try {
                // è¨­å®š 8 ç§’è¶…æ™‚
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);

                const response = await fetch(GOOGLE_SCRIPT_URL, { signal: controller.signal });
                const data = await response.json();
                
                cachedData = data;
                localStorage.setItem('bse_camp_data', JSON.stringify(data));
                console.log("é›²ç«¯è³‡æ–™åŒæ­¥æˆåŠŸ");
            } catch (err) {
                console.warn("é€£ç·šå¤±æ•—ï¼Œä½¿ç”¨ç·©å­˜:", err);
                if (!cachedData) {
                    alert("âš ï¸ ç„¡æ³•é€£ç·šä¸”ç„¡èˆŠè³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ï¼");
                } else {
                    alert("âš ï¸ ç¶²è·¯ä¸ç©©ï¼Œç›®å‰ä½¿ç”¨é›¢ç·šæ¨¡å¼");
                }
            }
        }

        // æ¸²æŸ“æ‰€æœ‰å¾ Sheet ä¾†çš„è³‡æ–™
        function renderAll() {
            if (!cachedData) return;
            renderAnnouncements();
            renderScoreboard();
            renderInfo();
            initSchedule();
        }

        // ==========================================
        //  B. å„å€å¡Šæ¸²æŸ“é‚è¼¯
        // ==========================================
        
        // 1. å…¬å‘Š (æ”¯æ´ Urgent)
        function renderAnnouncements() {
            const container = document.getElementById('announcement-container');
            const data = cachedData.announcements || [];
            const activeList = data.filter(a => String(a.active).toUpperCase() === "TRUE");

            if (activeList.length === 0) {
                container.innerHTML = `<div class="card"><p style="color:#888;">ç›®å‰æ²’æœ‰å…¬å‘Š</p></div>`;
                return;
            }

            container.innerHTML = activeList.map(a => {
                const isUrgent = String(a.urgent || "").toUpperCase() === "TRUE";
                return `
                <div class="card ${isUrgent ? 'urgent' : ''}">
                    <h3 style="margin:0 0 8px 0; color:${isUrgent ? 'var(--urgent)' : 'var(--text)'};">
                        ${isUrgent ? '<i class="fas fa-exclamation-circle"></i> ' : '<i class="fas fa-info-circle"></i> '}${a.title}
                    </h3>
                    <p style="margin:0; font-size:15px; line-height:1.5;">${a.content}</p>
                    <small style="color:#aaa; display:block; margin-top:10px; text-align:right;">${a.date}</small>
                </div>`;
            }).join('');
        }

        // 2. è¡Œç¨‹è¡¨
        function initSchedule() {
            const data = cachedData.schedule || [];
            if(data.length === 0) return;

            const days = [...new Set(data.map(i => i.day))];
            
            // è‡ªå‹•é¸å–ç•¶å¤©
            const now = mockTime || new Date();
            const dateStr = (now.getMonth()+1) + "/" + now.getDate();
            if (!currentTabDay) {
                currentTabDay = days.includes(dateStr) ? dateStr : days[0];
            }

            // æ¸²æŸ“ Tabs
            const tabs = document.getElementById('day-tabs');
            tabs.innerHTML = days.map(d => `
                <div class="day-tab ${d === currentTabDay ? 'active' : ''}" onclick="window.setTab('${d}')">
                    ${d}
                </div>
            `).join('');
            
            renderScheduleList();
            updateHomeStatus();
            
            // æ¯åˆ†é˜æ›´æ–°ä¸€æ¬¡ç‹€æ…‹
            if(!window.statusInterval) window.statusInterval = setInterval(updateHomeStatus, 60000);
        }

        window.setTab = function(day) {
            currentTabDay = day;
            initSchedule(); // é‡ç¹ª
        };

        function renderScheduleList() {
            const list = document.getElementById('schedule-list');
            const dayData = (cachedData.schedule || []).filter(i => i.day == currentTabDay);
            
            list.innerHTML = dayData.map(item => `
                <div class="schedule-item">
                    <div class="time-badge">${item.time}</div>
                    <div style="flex:1;">
                        <div style="font-weight:bold; font-size:16px;">${item.title}</div>
                        <div style="font-size:13px; color:#888; margin-top:4px;">
                            <i class="fas fa-map-marker-alt"></i> ${item.loc}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateHomeStatus() {
            const now = mockTime || new Date();
            const timeVal = now.getHours() * 60 + now.getMinutes();
            const dateStr = (now.getMonth()+1) + "/" + now.getDate();
            
            const todayEvents = (cachedData.schedule || []).filter(e => e.day == dateStr);
            const current = todayEvents.find(e => {
                const [h, m] = String(e.time).split(':');
                const t = parseInt(h)*60 + parseInt(m);
                // å‡è¨­æ¯å€‹æ´»å‹• 1 å°æ™‚ï¼Œæˆ–ç›´åˆ°ä¸‹å€‹æ´»å‹•é–‹å§‹
                return timeVal >= t && timeVal < t + 60;
            });

            if (current) {
                document.getElementById('home-status-title').innerText = current.title;
                document.getElementById('home-status-time').innerText = `æ­£åœ¨é€²è¡Œ (${current.loc})`;
            } else {
                document.getElementById('home-status-title').innerText = "ç›®å‰ç„¡æ´»å‹•";
                document.getElementById('home-status-time').innerText = "ä¼‘æ¯ä¸­";
            }
        }

        // 3. æˆ°æ³æ¿
        function renderScoreboard() {
            const data = cachedData.scores || [];
            const container = document.getElementById('scoreboard');
            if (data.length === 0) { container.innerHTML = "ç„¡æ•¸æ“š"; return; }

            const max = Math.max(...data.map(s => s.score), 100);

            container.innerHTML = data.map(s => `
                <div style="display:flex; align-items:center; margin-bottom:12px;">
                    <span style="width:50px; font-weight:bold;">ç¬¬ ${s.id} å°</span>
                    <div style="flex:1; height:12px; background:#eee; border-radius:6px; margin:0 10px; overflow:hidden;">
                        <div style="width:${(s.score/max)*100}%; background:var(--secondary); height:100%;"></div>
                    </div>
                    <span style="width:40px; text-align:right; font-weight:bold;">${s.score}</span>
                </div>
            `).join('');
        }

        // 4. è³‡è¨Šé  (æ”¯æ´ Type)
        function renderInfo() {
            const container = document.getElementById('info-list');
            const data = cachedData.info || [];
            
            container.innerHTML = data.map(i => {
                let btn = "";
                if (i.type === "tel" && i.value) {
                    btn = `<button class="btn" onclick="window.location.href='tel:${i.value}'"><i class="fas fa-phone"></i> æ’¥æ‰“é›»è©±</button>`;
                } else if (i.type === "link" && i.value) {
                    btn = `<button class="btn btn-secondary" onclick="window.open('${i.value}')"><i class="fas fa-external-link-alt"></i> é–‹å•Ÿé€£çµ</button>`;
                }
                
                return `
                <div class="card">
                    <h3 style="margin:0 0 5px 0;">${i.title}</h3>
                    <p style="color:#666; margin:0 0 15px 0;">${i.content}</p>
                    ${btn}
                </div>`;
            }).join('');
        }

        // ==========================================
        //  C. Firebase åŠŸèƒ½ (å¯¦é©—èˆ‡è¨è«–)
        // ==========================================
        
        // C1. å¯¦é©—æ•¸æ“šåŒæ­¥
        function initGroupSync(groupId) {
            document.getElementById('exp-group-num').innerText = groupId;
            onSnapshot(doc(db, "groups", "group_" + groupId), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if(data.labData) {
                        ['lab-ph', 'lab-temp', 'lab-ec', 'lab-tb', 'lab-note'].forEach(id => {
                            // è‹¥ä½¿ç”¨è€…æ­£åœ¨è¼¸å…¥ï¼Œä¸è¦è¦†è“‹
                            if(document.activeElement.id !== id) {
                                document.getElementById(id).value = data.labData[id] || "";
                            }
                        });
                        if(data.labLastEditor) {
                            const timeStr = data.labTime ? new Date(data.labTime).toLocaleTimeString() : "";
                            document.getElementById('exp-status').innerText = `æœ€å¾Œæ›´æ–°: ${data.labLastEditor} (${timeStr})`;
                        }
                    }
                }
            });
        }

        window.saveLabData = async function() {
            const btn = document.getElementById('exp-btn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¸Šå‚³ä¸­...';
            
            const labData = {
                'lab-ph': document.getElementById('lab-ph').value,
                'lab-temp': document.getElementById('lab-temp').value,
                'lab-ec': document.getElementById('lab-ec').value,
                'lab-tb': document.getElementById('lab-tb').value,
                'lab-note': document.getElementById('lab-note').value
            };

            try {
                await setDoc(doc(db, "groups", "group_" + currentUser.group), {
                    labData: labData,
                    labLastEditor: currentUser.name,
                    labTime: new Date().toISOString()
                }, { merge: true });
                btn.innerHTML = '<i class="fas fa-check"></i> ä¸Šå‚³æˆåŠŸ';
                setTimeout(() => btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> ä¸Šå‚³æ•¸æ“š', 1500);
            } catch(e) {
                console.error(e);
                alert("ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
                btn.innerHTML = '<i class="fas fa-redo"></i> é‡è©¦';
            }
        };

        // C2. è¨è«–å€
        function initDiscussion(groupId) {
            if(unsubscribeTopics) unsubscribeTopics();
            const ref = collection(db, "groups", "group_" + groupId, "topics");
            
            unsubscribeTopics = onSnapshot(query(ref, orderBy("createdAt", "desc")), (snapshot) => {
                const container = document.getElementById("topics-container");
                if (snapshot.empty) {
                    container.innerHTML = "<p style='text-align:center; color:#ccc; padding:20px;'>å°šç„¡è¨è«–ï¼Œå¿«ä¾†ç™¼èµ·ç¬¬ä¸€å€‹ï¼</p>";
                    return;
                }
                
                container.innerHTML = "";
                snapshot.forEach(doc => {
                    const d = doc.data();
                    const div = document.createElement("div");
                    div.className = "topic-item";
                    div.innerHTML = `
                        <h3 style="margin:0 0 5px 0;">${d.title}</h3>
                        <p style="color:#666; font-size:13px; margin:0;">${d.content.substring(0,30)}...</p>
                        <div style="text-align:right; font-size:12px; color:#aaa; margin-top:5px;">
                            <i class="fas fa-user"></i> ${d.author}
                        </div>
                    `;
                    div.onclick = () => openDiscussion(doc.id, d);
                    container.appendChild(div);
                });
            });
        }

        function openDiscussion(docId, data) {
            currentTopicId = docId;
            document.getElementById("topic-list-section").style.display = "none";
            document.getElementById("discussion-section").style.display = "block";
            
            document.getElementById("view-topic-title").innerText = data.title;
            document.getElementById("view-topic-content").innerText = data.content;
            document.getElementById("view-topic-author").innerText = data.author;
            
            loadComments(docId);
        }

        function loadComments(topicId) {
            if(unsubscribeComments) unsubscribeComments();
            const ref = collection(db, "groups", "group_" + currentUser.group, "topics", topicId, "comments");
            
            unsubscribeComments = onSnapshot(query(ref, orderBy("createdAt", "asc")), (snapshot) => {
                const list = document.getElementById("comments-list");
                list.innerHTML = "";
                
                snapshot.forEach(doc => {
                    const c = doc.data();
                    const div = document.createElement("div");
                    div.className = "comment-item";
                    div.innerHTML = `
                        <div style="font-size:12px; color:#888; margin-bottom:4px;">${c.user}</div>
                        <div>${c.message}</div>
                    `;
                    list.appendChild(div);
                });
                // è‡ªå‹•æ²å‹•åˆ°åº•éƒ¨
                window.scrollTo(0, document.body.scrollHeight);
            });
        }

        // ç™¼ä½ˆä¸»é¡ŒæŒ‰éˆ•
        document.getElementById("btn-create-topic").onclick = async () => {
            const t = document.getElementById("new-topic-title").value;
            const c = document.getElementById("new-topic-content").value;
            if(!t || !c) return alert("è«‹è¼¸å…¥æ¨™é¡Œèˆ‡å…§å®¹");
            
            await addDoc(collection(db, "groups", "group_" + currentUser.group, "topics"), {
                title: t, content: c, author: currentUser.name, createdAt: serverTimestamp()
            });
            document.getElementById("new-topic-title").value = "";
            document.getElementById("new-topic-content").value = "";
        };

        // ç™¼é€ç•™è¨€æŒ‰éˆ•
        document.getElementById("btn-send-comment").onclick = async () => {
            const msg = document.getElementById("my-comment").value;
            if(!msg) return;
            
            await addDoc(collection(db, "groups", "group_" + currentUser.group, "topics", currentTopicId, "comments"), {
                user: currentUser.name, message: msg, createdAt: serverTimestamp()
            });
            document.getElementById("my-comment").value = "";
        };

        // å›åˆ—è¡¨æŒ‰éˆ•
        document.getElementById("btn-back-to-topics").onclick = () => {
            document.getElementById("discussion-section").style.display = "none";
            document.getElementById("topic-list-section").style.display = "block";
            if(unsubscribeComments) unsubscribeComments();
        };

        // ==========================================
        //  D. é é¢å°èˆªèˆ‡å·¥å…·
        // ==========================================
        window.switchPage = function(pageId, navEl) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            
            if(navEl) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                navEl.classList.add('active');
            }
            // é‡ç½®å­é é¢ç‹€æ…‹
            if(pageId === 'notes-page') {
                document.getElementById("discussion-section").style.display = "none";
                document.getElementById("topic-list-section").style.display = "block";
            }
        };

        window.openSubPage = function(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            // ä¿æŒæ´»å‹•é ç±¤é«˜äº®
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelectorAll('.nav-item')[2].classList.add('active');
        };

        // æ™‚å…‰æ©Ÿ (DevMode)
        window.toggleDevMode = function() {
            const input = prompt("ã€æ™‚å…‰æ©Ÿã€‘æ¸¬è©¦ç”¨\nè«‹è¼¸å…¥æ¨¡æ“¬æ™‚é–“ (æ ¼å¼: 1/26 14:00)", "1/26 14:00");
            if(input) {
                const [d, t] = input.split(' ');
                mockTime = new Date(`2026/${d} ${t}:00`);
                renderAll(); // ç«‹å³åˆ·æ–°ç•Œé¢
                alert(`æ™‚é–“å·²åˆ‡æ›è‡³ ${input}`);
            }
        };
    </script>
</body>
</html>
